{% extends "app.html" %}

{% block main %}
<form name="conversation" enctype="multipart/form-data" method="post" action="" id="conversation">
    <div id="control-bar">
        <div id="control-elements">
            <h3>
                New Conversation
            </h3>
            <div id="control-bar-right">
                <input type="submit" name="submit" class="btn" value="Next"><input type="button" class="btn-grey" value="Back" onclick="javascript:history.go(-1)">
            </div>
        </div>
    </div>
    <div id="main">
        <div class="inner">
            {# TODO: fix this #}
            {# <div class="notification success"> #}
            {#     <strong>999 New Contacts Added to "Market Agents"</strong> - 3 duplicates and 20 invalid records found #}
            {# </div> #}
            <div id="progress-bar">
                <ul>
                    <li class="pre-active">Message</li><li class="active">People</li><li>Send</li>
                </ul>
            </div>
            <div class="wide-box">
                <div id="conv-box">
                    <div id="form-filter">
                        <ul>
                            <li id="groups" class="active">
                                <a href="#">Groups</a>
                            </li>
                            <li id="upload">
                                <a href="#">Upload...</a>
                            </li>
                        </ul>
                    </div><label class="group-label">Select which group(s) you'd like to message:</label>
                    <div id="groups-list">
                        {% for group in user.contactgroup_set.all %}
                        <div class="group {% if forloop.first %}first{% endif %}">
                            <input type="checkbox" name="groups" value="{{group.pk}}" class="group-check"> 
                            <span class="group-name">{{group.name}}</span>
                            <span class="group-member-count">{{group.contact_set.count}}</span>
                        </div>
                        {% empty %}
                        <div class="group first">
                            <p>
                                You don't have any groups defined yet. 
                                Upload a set of contacts to create your
                                first group.</p>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="upload-form">
                        <form name="uploader" enctype="multipart/form-data" action="" method="post" id="uploader">
                            <div class="field-row">
                                {{upload_contacts_form.errors}}
                                <label for="upload-contacts" class="wide">Upload file with new contacts (csv files only)</label> 
                                {{upload_contacts_form.file}}
                                <div class="clear"></div>
                            </div>
                            {% if user.contactgroup_set.exists %}
                                <div class="field-row">
                                    {{select_contact_group_form.errors}}
                                    <label for="existinggroup" class="wide">Add these contacts to an existing group</label>
                                    {{select_contact_group_form.contact_group}}
                                    <div class="clear"></div>
                                </div>
                            {% endif %}
                            <div class="field-row">
                                {{new_contact_group_form.errors}}
                                <label for="newgroup" class="wide">
                                    {% if user.contactgroup_set.exists %}
                                        Or, create a new group
                                    {% else %}
                                        Save as group
                                    {% endif %}</label> 
                                {{new_contact_group_form.name}}
                                <div class="clear"></div>
                            </div><input type="submit" name="upload" value="Upload" class="btn">
                            {% csrf_token %}
                        </form>
                    </div>
                </div>
                <div id="preview-box">
                    <div id="preview-pane">
                        <span class="sender">{{user_profile}}:</span> <span class="preview-message">{{conversation.message}}</span>
                    </div>
                </div>
                <div class="clear"></div>
            </div>
            <div class="clear">
                &nbsp;
            </div>
        </div>
    </div>
    {% csrf_token %}
</form>
{% endblock %}